// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/infra/database/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                     String    @id @unique
  ext_id                 String?   @unique
  name                   String
  email                  String    @unique
  password               String?
  created_at             DateTime
  updated_at             DateTime?
  deleted_at             DateTime?
  stripe_customer_id     String?   @unique
  stripe_subscription_id String?
  stripe_price_id        String?
  subscription_status    String?
  ai_credits             Int       @default(0)
  ai_credits_reset_at    DateTime?

  sessions                      Session[]
  activation_tokens             ActivationToken[]
  organization                  Organization?
  members                       Member[]
  organization_invites_sent     OrganizationInvite[] @relation("organization_invites_sent")
  organization_invites_received OrganizationInvite[] @relation("organization_invites_received")

  @@map("users")
}

model Session {
  id            String    @id @unique
  refresh_token String
  expires_at    DateTime
  created_at    DateTime
  updated_at    DateTime?
  deleted_at    DateTime?

  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user_id String

  @@map("sessions")
}

model ActivationToken {
  id         String    @id @unique
  expires_at DateTime
  used_at    DateTime?
  created_at DateTime
  updated_at DateTime?

  user    User   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user_id String

  @@map("activation_tokens")
}

model Organization {
  id         String    @id @unique
  name       String
  created_at DateTime
  updated_at DateTime?
  deleted_at DateTime?

  creator    User   @relation(fields: [creator_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  creator_id String @unique

  members   Member[]
  api_keys  ApiKey[]
  libraries Library[]
  invites   OrganizationInvite[]

  @@map("organizations")
}

model Member {
  id         String    @id @unique
  features   String[]
  created_at DateTime
  updated_at DateTime?
  deleted_at DateTime?

  user      User         @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user_id   String
  org       Organization @relation(fields: [org_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  org_id    String
  maps      Map[]
  map_likes MapLike[]

  @@unique([org_id, user_id])
  @@map("members")
}

model Map {
  id              String    @id @unique
  title           String
  content         Json
  preview         String?   @db.Text
  generated_by_ai Boolean   @default(false)
  created_at      DateTime
  updated_at      DateTime?
  deleted_at      DateTime?

  member    Member       @relation(fields: [member_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  member_id String
  libraries MapLibrary[]
  likes     MapLike[]

  @@map("maps")
}

model MapLike {
  id         String   @id @unique
  map        Map      @relation(fields: [map_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  map_id     String
  member     Member   @relation(fields: [member_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  member_id  String
  created_at DateTime

  @@unique([map_id, member_id])
  @@map("map_likes")
}

model Library {
  id              String       @id @unique
  name            String
  created_at      DateTime
  updated_at      DateTime?
  deleted_at      DateTime?
  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  organization_id String
  maps            MapLibrary[]

  @@map("libraries")
}

model MapLibrary {
  map        Map     @relation(fields: [map_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  map_id     String
  library    Library @relation(fields: [library_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  library_id String

  @@id([map_id, library_id])
  @@map("maps_libraries")
}

model ApiKey {
  id           String    @id @unique
  features     String[]
  env          String
  secret       String
  prefix       String    @unique
  created_at   DateTime
  last_used_at DateTime
  revoked_at   DateTime?
  expires_at   DateTime?
  updated_at   DateTime?
  deleted_at   DateTime?

  organization    Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  organization_id String

  @@map("api_keys")
}

model OrganizationInvite {
  id                 String       @id @unique
  email              String
  status             String
  responded_at       DateTime?
  created_at         DateTime
  updated_at         DateTime?
  deleted_at         DateTime?
  organization       Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  organization_id    String
  invited_by_user    User         @relation("organization_invites_sent", fields: [invited_by_user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  invited_by_user_id String
  invited_user       User         @relation("organization_invites_received", fields: [invited_user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  invited_user_id    String

  @@index([invited_user_id, status])
  @@map("organization_invites")
}
